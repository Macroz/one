"use strict";var app=angular.module("oneApp",["ngRoute"]);app.config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]);var app=angular.module("oneApp");app.factory("Common",function(){function a(){}function b(a){if(a){var b={};b.width=$(".canvas").width(),b.height=$(".canvas").height(),b.ratio=b.width/b.height;var c={};c.width=1024,c.height=1024,c.ratio=c.width/c.height,console.log(b.width+"x"+b.height);var d,e,f=b.width,g=b.height*c.ratio,h=b.width/c.ratio,i=b.height;c.ratio>b.ratio?(d=f,e=h):(d=g,e=i),a.width=d,a.height=e,a.x=.5*(b.width-a.width),a.y=.5*(b.height-a.height),$("canvas").width(b.width),$("canvas").height(b.height),$("canvas").attr("width",b.width),$("canvas").attr("height",b.height)}}function c(a,b,c,d,e,f){a.beginPath(),a.moveTo(-.5*d,-.5*e),a.moveTo(b+f,c),a.lineTo(b+d-f,c),a.quadraticCurveTo(b+d,c,b+d,c+f),a.lineTo(b+d,c+e-f),a.quadraticCurveTo(b+d,c+e,b+d-f,c+e),a.lineTo(b+f,c+e),a.quadraticCurveTo(b,c+e,b,c+e-f),a.lineTo(b,c+f),a.quadraticCurveTo(b,c,b+f,c),a.closePath()}var d={};return d.reset=a,d.resize=b,d.roundRect=c,d});var app=angular.module("oneApp");app.factory("GameScene",["Common",function(a){function b(){var a=$("canvas");if(a.length>0){var b=a[0].getContext("2d");if(b&&u){{u.tick}b.fillStyle="#ffffff",b.fillRect(0,0,a[0].width,a[0].height),b.font="32px Georgia",b.fillStyle="#e5e5e5",b.fillText(u.level+1,20,20);for(var c=0;c<u.objects.length;++c){var d=u.objects[c];d.draw(b)}}}}function c(){a.resize(u)}function d(b,c){var d=1024/(2*u.size+1)/1.2,j={};return j.gx=b,j.gy=c,j.x=b*d*1.2,j.y=c*d*1.2,j.width=d,j.height=d,j.accessible=function(a,d){return a==b-1&&d==c?!0:a==b+1&&d==c?!0:a==b&&d==c-1?!0:a==b&&d==c+1?!0:!1},j.draw=function(b){if(j.visible){b.fillStyle="#e5e5e5",j.expanded&&(b.fillStyle="#ffffff",j.onesmell?b.fillStyle=u.win?"#c0e5c0":"#e5c0c0":j.othersmell&&(b.fillStyle="#a6b6e6"),j.one&&(b.fillStyle="#e54444",j.chosen&&(b.fillStyle="#44e544")),j.other&&(b.fillStyle="#4444e6"));var c=u.choosing?.5*(u.tick-u.choosing.tick):0,d=j.choosing?1+.1*Math.sin(c):1,e=u.x+.5*u.width+(j.x-d*j.width*.5)/1024*u.width,f=u.y+.5*u.height+(j.y-d*j.height*.5)/1024*u.height,g=d*j.width/1024*u.width,h=d*j.height/1024*u.height,i=d*j.width/10;a.roundRect(b,e,f,g,h,i),b.fill()}},j.choose=function(){j.one?(j.expanded=!0,j.chosen=!0,f()):g()},j.expand=function(){if(j.visible&&!j.expanded){if(j.expanded=!0,p("expand"),j.one)return i(),void 0;if(j.other)return h(),void 0;var a=j.gx,b=j.gy;e(a,b,1,function(c){(c.gx!=a||c.gy!=b)&&(c.visible=!0)})}},j.contains=function(a,b){return a>j.x-.5*j.width&&a<j.x+.5*j.width&&b>j.y-.5*j.height&&b<j.y+.5*j.height},j.click=function(){j.expand()},u.objects.push(j),j}function e(a,b,c,d){for(var e=-c;c>=e;++e)for(var f=-c;c>=f;++f){var g=a+f,h=b+e;g>=-u.size&&g<=u.size&&h>=-u.size&&h<=u.size&&d(u.grid[g+"_"+h])}}function f(){u.interactive=!1,delete u.choosing.block.choosing,u.win=!0,p("win"),setTimeout(function(){++u.level,j()},2e3)}function g(){u.interactive=!1,p("miss"),setTimeout(function(){u.level>1?--u.level:u.level<0&&(u.level=0),j()},2e3)}function h(){u.interactive=!1,p("other"),setTimeout(function(){j()},2e3)}function i(){u.interactive=!1,p("fail"),setTimeout(function(){u.level>1?--u.level:u.level<0&&(u.level=0),j()},2e3)}function j(){u.tick=0,u.objects=[],u.grid={},u.size=u.level,u.win=!1,u.interactive=!0,delete u.choosing,u.block=function(a,b){return a>=-u.size&&a<=u.size&&b>=-u.size&&b<=u.size?u.grid[a+"_"+b]:void 0};for(var a=-u.size;a<=u.size;++a)for(var b=-u.size;b<=u.size;++b){var c=d(b,a);u.grid[b+"_"+a]=c,0==b&&0==a&&(c.visible=!0)}for(var f=!1;!f;){var b=Math.round(2*Math.random()*u.size)-u.size,a=Math.round(2*Math.random()*u.size)-u.size;if(0!=b||0!=a||0==u.level){f=!0;var c=u.block(b,a);c.one=!0,e(b,a,1,function(a){a.onesmell=!0})}}for(var g=[];g.length<Math.floor((u.level-2)/2)&&u.level>3;){var b=Math.round(2*Math.random()*u.size)-u.size,a=Math.round(2*Math.random()*u.size)-u.size;if((0!=b||0!=a)&&!u.block(b,a).one){var c=u.block(b,a);c.other=!0,e(b,a,2,function(a){a.othersmell=!0}),g.push(c)}}g.length>0?$(".others").show():$(".others").hide()}function k(a){var b=new Audio(a);return b.volume=.1,b}function l(a){u={},u.level=a||0,u.sounds={},u.sounds.expand=k("/sounds/expand.wav"),u.sounds.choose=k("/sounds/choose.wav"),u.sounds.fail=k("/sounds/fail.wav"),u.sounds.miss=k("/sounds/miss.wav"),u.sounds.win=k("/sounds/win.wav"),u.sounds.other=k("/sounds/other.wav"),j(),$(window).resize(c)}function m(){u.tick++,b();var a=Math.round(u.tick/12)%10;if($(".one").removeClass("red").removeClass("green"),7==a?$(".one").addClass("red"):8==a&&$(".one").addClass("green"),u.mousedown&&u.tick-u.mousedown.tick>=25){var c=u.mousedown.block;c&&!u.choosing&&(u.choosing={block:c,tick:u.tick},c.choosing=!0),p("choose")}}function n(){u.simulation=setInterval(m,20)}function o(){u.simulation&&clearInterval(u.simulation)}function p(a){u.sounds[a].play()}function q(a){if(u.interactive){var b=$(this).offset(),c=a.pageX-b.left,d=a.pageY-b.top,e=(c-u.x)/u.width*1024-512,f=(d-u.y)/u.height*1024-512,g=s(e,f);g&&(u.mousedown={},u.mousedown.tick=u.tick,u.mousedown.x=e,u.mousedown.y=f,u.mousedown.block=g)}}function r(){if(u.interactive&&u.mousedown){var a=s(u.mousedown.x,u.mousedown.y);a&&(u.tick-u.mousedown.tick<25?a.click():a.choose(),delete u.mousedown)}}function s(a,b){for(var c=0;c<u.objects.length;++c){var d=u.objects[c];if(d.visible&&d.contains(a,b))return d}}function t(){}var u={},v={};return v.resize=c,v.reset=l,v.draw=b,v.activate=n,v.passivate=o,v.simulate=m,v.click=t,v.mousedown=q,v.mouseup=r,u.win=f,u.fail=i,u.setup=j,v}]),app.controller("MainCtrl",["$scope","$routeParams","GameScene",function(a,b,c){c.reset(b.level),c.resize(),c.activate(),a.$on("$destroy",c.passivate),$("canvas").mousedown(c.mousedown),$("canvas").mouseup(c.mouseup)}]);